{% extends "base.html" %}

{% block title %}Upload incident · Smart Accident Monitor{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS for map -->
<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
/>
<style>
    #incident-map {
        width: 100%;
        height: 260px;
        border-radius: 0.9rem;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.5);
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.7);
        margin-top: 0.4rem;
    }

    .leaflet-container {
        background: #020617;
    }

    .map-controls {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex-wrap: wrap;
        margin-top: 0.4rem;
    }

    .btn-secondary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 0.9rem;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.7);
        background: rgba(15, 23, 42, 0.9);
        font-size: 0.78rem;
        font-weight: 500;
        color: #e5e7eb;
        cursor: pointer;
        outline: none;
        transition: background 0.15s ease-out, box-shadow 0.15s ease-out, transform 0.12s ease-out;
    }

    .btn-secondary:hover {
        background: rgba(30, 64, 175, 0.85);
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.6);
        transform: translateY(-1px);
    }

    .btn-secondary:active {
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.9);
    }

    .btn-secondary[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
    }
</style>
{% endblock %}

{% block header %}
<div class="badge">
    <span class="badge-dot"></span>
    Mobile-first capture
</div>
<h1 class="content-title">Upload an accident video with map-based location</h1>
<p class="content-subtitle">
    Just like booking a cab: record or pick the video, then either tap <strong>Use my current
    location</strong> or select the incident spot on the map. No one is typing coordinates.
</p>
{% endblock %}

{% block content %}
{% if message %}
<div class="alert alert-success">
    {{ message }}
</div>
{% endif %}

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" class="form" id="incident-form">
    <!-- VIDEO INPUT WITH CAMERA/GALLERY OPTIONS -->
    <div class="form-row">
        <label class="form-label">Accident video</label>

        <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem; flex-wrap:wrap;">
            <button
                type="button"
                class="btn-primary"
                id="mode-camera-btn"
                style="padding-inline:0.9rem; font-size:0.78rem;"
            >
                Record now (camera)
            </button>
            <button
                type="button"
                class="btn-primary"
                id="mode-gallery-btn"
                style="padding-inline:0.9rem; font-size:0.78rem; background:linear-gradient(135deg,#4b5563,#1f2937); box-shadow:none;"
            >
                Choose from gallery
            </button>
        </div>

        <!-- Camera-first input -->
        <input
            class="form-input"
            id="video-camera"
            type="file"
            accept="video/*"
            capture="environment"
            required
        >

        <!-- Gallery input -->
        <input
            class="form-input"
            id="video-gallery"
            type="file"
            accept="video/*"
            style="display:none; margin-top:0.55rem;"
        >

        <p class="form-hint">
            <strong>Camera mode:</strong> opens your camera to record a new clip.<br>
            <strong>Gallery mode:</strong> lets you pick an existing accident video.
        </p>
    </div>

    <!-- HIDDEN FIELDS BACKEND USES -->
    <input type="hidden" id="location_lat" name="location_lat">
    <input type="hidden" id="location_lng" name="location_lng">

    <!-- MAP + "USE CURRENT LOCATION" UX -->
    <div class="form-row">
        <label class="form-label">
            Incident location
            <span>(select on map or use your current location)</span>
        </label>

        <div id="incident-map"></div>

        <div class="map-controls">
            <button type="button" class="btn-secondary" id="use-current-location-btn">
                Use my current location
            </button>
            <span id="location-status" class="location-status loading">
                Tap on the map to set the accident spot, or use your current location.
            </span>
        </div>

        <p class="form-hint" id="location-details" style="display:none;"></p>
        <p class="form-hint">
            Pan/zoom the map and tap exactly where the accident happened. If you are standing near the
            scene, <strong>Use my current location</strong> is usually accurate enough.
        </p>
    </div>

    <!-- OPTIONAL TEXT DESCRIPTION / ADDRESS -->
    <div class="form-row">
        <label class="form-label" for="description">
            Description / address <span>(optional)</span>
        </label>
        <textarea
            class="form-textarea"
            id="description"
            name="description"
            placeholder="Landmarks, direction of travel, injuries, number of vehicles, etc."
        ></textarea>
    </div>

    <button type="submit" class="btn-primary" id="submit-btn" disabled>
        Submit incident
    </button>
</form>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JS -->
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
></script>

<script>
    (function () {
        // ----------------------------
        // VIDEO MODE TOGGLE
        // ----------------------------
        const cameraBtn = document.getElementById("mode-camera-btn");
        const galleryBtn = document.getElementById("mode-gallery-btn");
        const cameraInput = document.getElementById("video-camera");
        const galleryInput = document.getElementById("video-gallery");

        function setVideoMode(mode) {
            if (mode === "camera") {
                cameraBtn.style.background = "linear-gradient(135deg, #2563eb, #4f46e5)";
                cameraBtn.style.boxShadow = "0 12px 30px rgba(37,99,235,0.45),0 0 0 1px rgba(37,99,235,0.6)";
                galleryBtn.style.background = "linear-gradient(135deg,#4b5563,#1f2937)";
                galleryBtn.style.boxShadow = "none";

                cameraInput.style.display = "block";
                galleryInput.style.display = "none";

                cameraInput.required = true;
                galleryInput.required = false;

                cameraInput.name = "video";
                galleryInput.name = "";
            } else {
                galleryBtn.style.background = "linear-gradient(135deg, #2563eb, #4f46e5)";
                galleryBtn.style.boxShadow = "0 12px 30px rgba(37,99,235,0.45),0 0 0 1px rgba(37,99,235,0.6)";
                cameraBtn.style.background = "linear-gradient(135deg,#4b5563,#1f2937)";
                cameraBtn.style.boxShadow = "none";

                cameraInput.style.display = "none";
                galleryInput.style.display = "block";

                galleryInput.required = true;
                cameraInput.required = false;

                galleryInput.name = "video";
                cameraInput.name = "";
            }
        }

        cameraBtn.addEventListener("click", function () {
            setVideoMode("camera");
        });

        galleryBtn.addEventListener("click", function () {
            setVideoMode("gallery");
        });

        // Default mode: camera
        setVideoMode("camera");

        // ----------------------------
        // MAP + LOCATION LOGIC
        // ----------------------------
        const statusEl = document.getElementById("location-status");
        const detailsEl = document.getElementById("location-details");
        const useCurrentBtn = document.getElementById("use-current-location-btn");
        const latInput = document.getElementById("location_lat");
        const lngInput = document.getElementById("location_lng");
        const submitBtn = document.getElementById("submit-btn");

        let map, marker = null;
        let hasLocation = false;

        function setStatus(type, message) {
            statusEl.textContent = message;
            statusEl.classList.remove("loading", "ok", "error");
            if (type) {
                statusEl.classList.add(type);
            }
        }

        function enableSubmit(enable) {
            if (enable) {
                submitBtn.removeAttribute("disabled");
            } else {
                submitBtn.setAttribute("disabled", "disabled");
            }
        }

        function setLocation(lat, lng, label) {
            hasLocation = true;
            latInput.value = lat.toString();
            lngInput.value = lng.toString();

            // Update marker
            if (!marker) {
                marker = L.marker([lat, lng]).addTo(map);
            } else {
                marker.setLatLng([lat, lng]);
            }

            // Center map softly
            map.setView([lat, lng], Math.max(map.getZoom(), 14));

            // Update UI
            detailsEl.style.display = "block";
            detailsEl.textContent =
                "Lat: " + lat.toFixed(6) + " · Lng: " + lng.toFixed(6) +
                (label ? " (" + label + ")" : "");
            setStatus("ok", "Location set.");
            enableSubmit(true);
        }

        function initMap() {
            // Default center: India
            map = L.map("incident-map").setView([20.5937, 78.9629], 5);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            map.on("click", function (e) {
                setLocation(e.latlng.lat, e.latlng.lng, "selected on map");
            });

            setStatus("loading", "Tap on the map to mark the accident location, or use your current location.");
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) {
                setStatus("error", "This browser does not support location. Select on map instead.");
                return;
            }

            setStatus("loading", "Getting your current location...");
            useCurrentBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setLocation(lat, lng, "current device location");
                    useCurrentBtn.disabled = false;
                },
                function (error) {
                    console.warn("Geolocation error:", error);
                    let msg = "Unable to get current location.";
                    if (error.code === error.PERMISSION_DENIED) {
                        msg = "Location permission denied. Either allow it or tap on map to set the spot.";
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        msg = "Location is unavailable. Try again or tap on map.";
                    } else if (error.code === error.TIMEOUT) {
                        msg = "Location request timed out. Try again or tap on map.";
                    }
                    setStatus("error", msg);
                    useCurrentBtn.disabled = false;

                    // User can still pick on map even if geolocation fails.
                    if (!hasLocation) {
                        enableSubmit(false);
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        useCurrentBtn.addEventListener("click", function () {
            useCurrentLocation();
        });

        // Ensure we have a location before submit
        document.getElementById("incident-form").addEventListener("submit", function (e) {
            if (!latInput.value || !lngInput.value) {
                e.preventDefault();
                setStatus("error", "Please set the incident location on the map or use your current location.");
            }
        });

        // Boot
        initMap();
        enableSubmit(false);
    })();
</script>
{% endblock %}
