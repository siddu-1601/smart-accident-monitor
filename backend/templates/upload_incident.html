{% extends "base.html" %}

{% block title %}Upload incident · Smart Accident Monitor{% endblock %}

{% block header %}
<div class="badge">
    <span class="badge-dot"></span>
    Mobile-first capture
</div>
<h1 class="content-title">Upload an accident video with auto location</h1>
<p class="content-subtitle">
    Open this page on your phone, allow camera + location access, and record the incident live.
    Latitude and longitude are auto-captured from your device — no manual coordinates.
</p>
{% endblock %}

{% block content %}
{% if message %}
<div class="alert alert-success">
    {{ message }}
</div>
{% endif %}

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" class="form" id="incident-form">
    <div class="form-row">
        <label class="form-label" for="video">Accident video</label>
        <!-- camera-first UX: on mobile, this opens the camera directly in video mode -->
        <input
            class="form-input"
            id="video"
            name="video"
            type="file"
            accept="video/*"
            capture="environment"
            required
        >
        <p class="form-hint">
            On mobile: tap this field to <strong>record a new video</strong> using your camera, or select
            an existing clip from gallery. On desktop: you’ll see a normal file picker.
        </p>
    </div>

    <!-- Hidden location fields: auto-filled from GPS -->
    <input type="hidden" id="location_lat" name="location_lat">
    <input type="hidden" id="location_lng" name="location_lng">

    <div class="form-row">
        <label class="form-label">
            Location
            <span>(auto-captured from your device)</span>
        </label>
        <div class="location-status loading" id="location-status">
            Requesting GPS from your device...
        </div>
        <p class="form-hint" id="location-details" style="display:none;"></p>
        <p class="form-hint">
            You must allow <strong>location access</strong> in your browser. If you deny it, the incident
            cannot be submitted because severity and routing depend on GPS.
        </p>
    </div>

    <div class="form-row">
        <label class="form-label" for="description">Additional description <span>(optional)</span></label>
        <textarea
            class="form-textarea"
            id="description"
            name="description"
            placeholder="Describe what happened, visible injuries, blocked lanes, etc."
        ></textarea>
    </div>

    <button type="submit" class="btn-primary" id="submit-btn" disabled>
        Submit incident
    </button>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
    (function () {
        const statusEl = document.getElementById("location-status");
        const detailsEl = document.getElementById("location-details");
        const latInput = document.getElementById("location_lat");
        const lngInput = document.getElementById("location_lng");
        const submitBtn = document.getElementById("submit-btn");

        function setStatusLoading(message) {
            statusEl.textContent = message;
            statusEl.classList.remove("ok", "error");
            statusEl.classList.add("loading");
        }

        function setStatusOk(message) {
            statusEl.textContent = message;
            statusEl.classList.remove("loading", "error");
            statusEl.classList.add("ok");
        }

        function setStatusError(message) {
            statusEl.textContent = message;
            statusEl.classList.remove("loading", "ok");
            statusEl.classList.add("error");
        }

        function enableSubmit(enable) {
            if (enable) {
                submitBtn.removeAttribute("disabled");
            } else {
                submitBtn.setAttribute("disabled", "disabled");
            }
        }

        // Initial state
        enableSubmit(false);
        setStatusLoading("Requesting GPS from your device...");

        if (!navigator.geolocation) {
            setStatusError("This browser does not support location. Use a modern mobile browser.");
            enableSubmit(false);
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                latInput.value = lat.toString();
                lngInput.value = lng.toString();

                setStatusOk("Location captured from device.");
                detailsEl.style.display = "block";
                detailsEl.textContent = "Lat: " + lat.toFixed(6) + " · Lng: " + lng.toFixed(6);

                enableSubmit(true);
            },
            function (error) {
                console.warn("Geolocation error:", error);
                let msg = "Unable to retrieve location.";
                if (error.code === error.PERMISSION_DENIED) {
                    msg = "Location permission denied. Allow location to submit incidents.";
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                    msg = "Location is unavailable. Try again in an open area.";
                } else if (error.code === error.TIMEOUT) {
                    msg = "Location request timed out. Try again.";
                }
                setStatusError(msg);
                enableSubmit(false);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 5000
            }
        );
    })();
</script>
{% endblock %}
